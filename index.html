<!DOCTYPE html>
<html>

<head>
  <title>Chess</title>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
    crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/static/css/chessboard-1.0.0.min.css">
</head>

<body>
  <input name="next_move" type="text" placeholder="Next move" />

  <div id="board" style="width: 700px"></div>
  <button id="startBtn">Start</button>

  <div id="position"></div>

  <script src="/static/js/chessboard-1.0.0.min.js"></script>
  <script lang="javascript">
    // used to transmit user new position
    const websocket = new WebSocket("ws://localhost:3001/");

    // decides which color can play 'w' white or 'b' black
    let turn = 'b';

    function onDrop(source, target, piece, newPos, oldPos, orientation) {
      // detect who current turn is 
      const con1 = Boolean((turn === 'w' && piece.search(/b/)));
      const con2 = Boolean((turn === 'b' && piece.search(/w/)));
      if (con1 || con2) return 'snapback';

      // FEN chess positions
      const newPosFen = Chessboard.objToFen(newPos);
      const oldPosFen = Chessboard.objToFen(oldPos);

      // append current fen position to #position div  
      const posDiv = document.getElementById('position');
      const position = document.createTextNode(newPosFen + ',');
      posDiv.appendChild(position);

      const information = {
        new_pos: newPosFen,
        old_pos: oldPosFen,
        source: source,
        target: target,
        orientation: orientation,
        piece: piece
      };
      
      console.log(information);
      websocket.send(JSON.stringify(information));
    }

    function onChange(oldPos, newPos) {
      if (turn === 'w') turn = 'b';
      else turn = 'w';
    }

    const board = Chessboard('board', {
      draggable: true,
      orientation: 'white',
      onDrop: onDrop,
      onChange: onChange,
      position: 'start'
    });

    $('#startBtn').on('click', () => {
      board.start;
      websocket.send(board.position);
    });
  </script>
</body>

</html>